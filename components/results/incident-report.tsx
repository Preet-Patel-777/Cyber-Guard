"use client"

import { useRef } from "react"
import type { ReportFormData } from "@/lib/report-types"
import type { DetectedAttack } from "@/lib/detect-attacks"
import { Button } from "@/components/ui/button"
import { FileDown, Printer, Shield } from "lucide-react"

interface IncidentReportProps {
  data: ReportFormData
  attacks: DetectedAttack[]
}

const PLATFORM_LABELS: Record<string, string> = {
  website: "Website / Web App",
  android: "Mobile App (Android)",
  ios: "Mobile App (iOS)",
  desktop: "Desktop Application",
  email: "Email",
  messaging: "SMS / WhatsApp / Telegram",
  phone: "Phone Call",
  social: "Social Media",
  banking: "Online Banking / UPI App",
  qr: "QR Code Scan",
  wifi: "Public Wi-Fi",
  unsure: "Not Sure",
}

function generateReportText(data: ReportFormData, attacks: DetectedAttack[]): string {
  const now = new Date()
  const dateStr = now.toLocaleDateString("en-IN", {
    year: "numeric",
    month: "long",
    day: "numeric",
  })
  const timeStr = now.toLocaleTimeString("en-IN", {
    hour: "2-digit",
    minute: "2-digit",
  })

  const lines: string[] = []
  lines.push("=" .repeat(60))
  lines.push("CYBERGUARD â€” INCIDENT REPORT")
  lines.push("=" .repeat(60))
  lines.push("")
  lines.push(`Report Generated: ${dateStr} at ${timeStr}`)
  lines.push(`Report ID: CG-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}${String(now.getDate()).padStart(2, "0")}-${String(Math.floor(Math.random() * 9999)).padStart(4, "0")}`)
  lines.push("")
  lines.push("-".repeat(60))
  lines.push("SECTION 1: INCIDENT DETAILS")
  lines.push("-".repeat(60))
  lines.push("")
  lines.push(`Platform: ${PLATFORM_LABELS[data.platform] || data.platform}`)
  lines.push(`When: ${data.whenHappened}`)
  lines.push(`Clicked Suspicious Link: ${data.clickedSuspiciousLink}`)
  lines.push(`Downloaded File: ${data.downloadedFile}`)
  lines.push(`Shared OTP: ${data.sharedOTP}`)
  lines.push(`Allowed Remote Access: ${data.allowedRemoteAccess}`)
  lines.push(`Concern Level: ${data.concernLevel}/5`)
  lines.push("")

  if (data.suspiciousActivities.length > 0) {
    lines.push("Suspicious Activities Observed:")
    data.suspiciousActivities.forEach((a, i) => {
      lines.push(`  ${i + 1}. ${a}`)
    })
    lines.push("")
  }

  if (data.devicePermissions.length > 0) {
    lines.push("Device Permissions Granted:")
    data.devicePermissions.forEach((p) => lines.push(`  - ${p}`))
    lines.push("")
  }

  if (data.personalInfoShared.length > 0) {
    lines.push("Personal Information Shared:")
    data.personalInfoShared.forEach((p) => lines.push(`  - ${p}`))
    lines.push("")
  }

  if (data.accountAccessGiven.length > 0) {
    lines.push("Account Access Given:")
    data.accountAccessGiven.forEach((a) => lines.push(`  - ${a}`))
    lines.push("")
  }

  if (data.impacts.length > 0) {
    lines.push("Reported Impact:")
    data.impacts.forEach((i) => lines.push(`  - ${i}`))
    lines.push("")
  }

  lines.push("-".repeat(60))
  lines.push("SECTION 2: THREAT ANALYSIS")
  lines.push("-".repeat(60))
  lines.push("")
  lines.push(`Total Threats Identified: ${attacks.length}`)
  lines.push("")

  attacks.forEach((attack, i) => {
    lines.push(`--- Threat ${i + 1}: ${attack.name} [${attack.severity}] ---`)
    lines.push("")
    lines.push(`Description: ${attack.description}`)
    lines.push("")
    lines.push(`Potential Access: ${attack.attackerAccess}`)
    lines.push("")
    lines.push("Recommended Actions:")
    attack.actions.forEach((action, j) => {
      lines.push(`  ${j + 1}. ${action}`)
    })
    lines.push("")
    lines.push(`Report To: ${attack.reportTo.map((r) => `${r.name} (${r.url})`).join(", ")}`)
    lines.push("")
  })

  lines.push("-".repeat(60))
  lines.push("SECTION 3: OFFICIAL REPORTING RESOURCES")
  lines.push("-".repeat(60))
  lines.push("")
  lines.push("1. National Cyber Crime Portal: https://cybercrime.gov.in/")
  lines.push("2. CERT-In: https://www.cert-in.org.in/")
  lines.push("3. Cyber Crime Helpline: 1930")
  lines.push("4. RBI Sachet Portal: https://sachet.rbi.org.in/")
  lines.push("5. Local Police / FIR: Visit your nearest police station")
  lines.push("")
  lines.push("=" .repeat(60))
  lines.push("DISCLAIMER: This report is auto-generated by CyberGuard for")
  lines.push("informational purposes. It does not constitute legal advice.")
  lines.push("Please consult law enforcement and legal professionals for")
  lines.push("formal proceedings.")
  lines.push("=" .repeat(60))

  return lines.join("\n")
}

export function IncidentReport({ data, attacks }: IncidentReportProps) {
  const reportRef = useRef<HTMLDivElement>(null)
  const now = new Date()
  const dateStr = now.toLocaleDateString("en-IN", {
    year: "numeric",
    month: "long",
    day: "numeric",
  })
  const timeStr = now.toLocaleTimeString("en-IN", {
    hour: "2-digit",
    minute: "2-digit",
  })
  const reportId = `CG-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}${String(now.getDate()).padStart(2, "0")}-${String(Math.floor(Math.random() * 9999)).padStart(4, "0")}`

  function handleDownload() {
    const text = generateReportText(data, attacks)
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" })
    const url = URL.createObjectURL(blob)
    const a = document.createElement("a")
    a.href = url
    a.download = `CyberGuard-Incident-Report-${now.toISOString().split("T")[0]}.txt`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }

  function handlePrint() {
    window.print()
  }

  return (
    <div className="flex flex-col gap-6">
      {/* Action buttons */}
      <div className="flex flex-wrap items-center gap-3">
        <Button size="sm" className="gap-1.5" onClick={handleDownload}>
          <FileDown className="size-3.5" />
          Download Report (.txt)
        </Button>
        <Button
          variant="outline"
          size="sm"
          className="gap-1.5"
          onClick={handlePrint}
        >
          <Printer className="size-3.5" />
          Print Report
        </Button>
      </div>

      {/* Printable report card */}
      <div
        ref={reportRef}
        className="rounded-xl border border-border/60 bg-card/80 print:border-none print:bg-transparent"
      >
        {/* Report header */}
        <div className="border-b border-border/60 p-6 md:p-8 print:border-b print:border-gray-300">
          <div className="flex items-center gap-3 mb-4">
            <div className="flex size-10 items-center justify-center rounded-lg bg-primary/10 print:bg-gray-100">
              <Shield className="size-5 text-primary print:text-gray-800" />
            </div>
            <div>
              <h1 className="text-lg font-bold text-foreground print:text-black">
                CyberGuard Incident Report
              </h1>
              <p className="text-xs text-muted-foreground print:text-gray-500">
                Generated {dateStr} at {timeStr}
              </p>
            </div>
          </div>
          <div className="flex flex-wrap gap-4 text-xs text-muted-foreground print:text-gray-600">
            <span>
              <span className="font-medium text-foreground print:text-black">Report ID:</span>{" "}
              {reportId}
            </span>
            <span>
              <span className="font-medium text-foreground print:text-black">Threats:</span>{" "}
              {attacks.length} identified
            </span>
            <span>
              <span className="font-medium text-foreground print:text-black">Severity:</span>{" "}
              {attacks[0]?.severity || "N/A"}
            </span>
          </div>
        </div>

        {/* Section 1: Incident Details */}
        <div className="border-b border-border/60 p-6 md:p-8 print:border-b print:border-gray-300">
          <h2 className="mb-4 text-sm font-semibold uppercase tracking-wider text-primary print:text-gray-800">
            Section 1: Incident Details
          </h2>
          <div className="grid grid-cols-1 gap-3 text-sm sm:grid-cols-2">
            <div>
              <span className="text-xs font-medium text-muted-foreground print:text-gray-500">Platform</span>
              <p className="text-foreground print:text-black">
                {PLATFORM_LABELS[data.platform] || data.platform}
              </p>
            </div>
            <div>
              <span className="text-xs font-medium text-muted-foreground print:text-gray-500">When</span>
              <p className="text-foreground print:text-black">{data.whenHappened}</p>
            </div>
            <div>
              <span className="text-xs font-medium text-muted-foreground print:text-gray-500">Clicked Link</span>
              <p className="text-foreground print:text-black">{data.clickedSuspiciousLink}</p>
            </div>
            <div>
              <span className="text-xs font-medium text-muted-foreground print:text-gray-500">Downloaded File</span>
              <p className="text-foreground print:text-black">{data.downloadedFile}</p>
            </div>
            <div>
              <span className="text-xs font-medium text-muted-foreground print:text-gray-500">Shared OTP</span>
              <p className="text-foreground print:text-black">{data.sharedOTP}</p>
            </div>
            <div>
              <span className="text-xs font-medium text-muted-foreground print:text-gray-500">Remote Access</span>
              <p className="text-foreground print:text-black">{data.allowedRemoteAccess}</p>
            </div>
          </div>

          {data.suspiciousActivities.length > 0 && (
            <div className="mt-4">
              <span className="text-xs font-medium text-muted-foreground print:text-gray-500">
                Suspicious Activities
              </span>
              <ul className="mt-1 flex flex-col gap-1">
                {data.suspiciousActivities.map((a) => (
                  <li key={a} className="text-sm text-foreground print:text-black">
                    {"- "}{a}
                  </li>
                ))}
              </ul>
            </div>
          )}

          {data.personalInfoShared.length > 0 && (
            <div className="mt-4">
              <span className="text-xs font-medium text-muted-foreground print:text-gray-500">
                Personal Information Shared
              </span>
              <p className="mt-1 text-sm text-foreground print:text-black">
                {data.personalInfoShared.join(", ")}
              </p>
            </div>
          )}

          {data.devicePermissions.length > 0 && (
            <div className="mt-4">
              <span className="text-xs font-medium text-muted-foreground print:text-gray-500">
                Device Permissions Granted
              </span>
              <p className="mt-1 text-sm text-foreground print:text-black">
                {data.devicePermissions.join(", ")}
              </p>
            </div>
          )}

          {data.impacts.length > 0 && (
            <div className="mt-4">
              <span className="text-xs font-medium text-muted-foreground print:text-gray-500">
                Reported Impact
              </span>
              <p className="mt-1 text-sm text-foreground print:text-black">
                {data.impacts.join(", ")}
              </p>
            </div>
          )}
        </div>

        {/* Section 2: Threat Analysis */}
        <div className="border-b border-border/60 p-6 md:p-8 print:border-b print:border-gray-300">
          <h2 className="mb-4 text-sm font-semibold uppercase tracking-wider text-primary print:text-gray-800">
            Section 2: Threat Analysis
          </h2>
          <div className="flex flex-col gap-5">
            {attacks.map((attack, i) => (
              <div
                key={attack.name}
                className="rounded-lg border border-border/60 p-4 print:border print:border-gray-300"
              >
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-base font-bold text-foreground print:text-black">
                    {i + 1}. {attack.name}
                  </span>
                  <span
                    className={`rounded-full px-2 py-0.5 text-xs font-semibold ${
                      attack.severity === "Critical"
                        ? "bg-red-500/10 text-red-400 print:text-red-700"
                        : attack.severity === "High"
                        ? "bg-orange-500/10 text-orange-400 print:text-orange-700"
                        : attack.severity === "Medium"
                        ? "bg-yellow-500/10 text-yellow-400 print:text-yellow-700"
                        : "bg-green-500/10 text-green-400 print:text-green-700"
                    }`}
                  >
                    {attack.severity}
                  </span>
                </div>
                <p className="text-sm text-muted-foreground print:text-gray-600 mb-3">
                  {attack.description}
                </p>
                <p className="text-sm text-muted-foreground print:text-gray-600 mb-3">
                  <span className="font-medium text-foreground print:text-black">
                    Potential access:
                  </span>{" "}
                  {attack.attackerAccess}
                </p>
                <div className="text-sm">
                  <span className="font-medium text-foreground print:text-black">
                    Actions:
                  </span>
                  <ol className="mt-1 flex flex-col gap-1 pl-4 list-decimal text-muted-foreground print:text-gray-600">
                    {attack.actions.map((action, j) => (
                      <li key={j}>{action}</li>
                    ))}
                  </ol>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Section 3: Reporting Resources */}
        <div className="p-6 md:p-8">
          <h2 className="mb-4 text-sm font-semibold uppercase tracking-wider text-primary print:text-gray-800">
            Section 3: Official Reporting Resources
          </h2>
          <div className="flex flex-col gap-2 text-sm">
            <p className="text-foreground print:text-black">
              1. <span className="font-medium">National Cyber Crime Portal:</span>{" "}
              <span className="text-primary print:text-blue-700">https://cybercrime.gov.in/</span>
            </p>
            <p className="text-foreground print:text-black">
              2. <span className="font-medium">CERT-In:</span>{" "}
              <span className="text-primary print:text-blue-700">https://www.cert-in.org.in/</span>
            </p>
            <p className="text-foreground print:text-black">
              3. <span className="font-medium">Cyber Crime Helpline:</span> 1930
            </p>
            <p className="text-foreground print:text-black">
              4. <span className="font-medium">RBI Sachet Portal:</span>{" "}
              <span className="text-primary print:text-blue-700">https://sachet.rbi.org.in/</span>
            </p>
            <p className="text-foreground print:text-black">
              5. <span className="font-medium">Local Police / FIR:</span> Visit your nearest police station
            </p>
          </div>

          <div className="mt-6 rounded-lg border border-border/60 bg-secondary/40 p-4 text-xs text-muted-foreground print:border print:border-gray-300 print:bg-gray-50 print:text-gray-500">
            <span className="font-medium text-foreground print:text-black">Disclaimer:</span>{" "}
            This report is auto-generated by CyberGuard for informational purposes. It
            does not constitute legal advice. Please consult law enforcement and legal
            professionals for formal proceedings.
          </div>
        </div>
      </div>
    </div>
  )
}
